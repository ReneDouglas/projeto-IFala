# ========================================
# DOCKER COMPOSE - AMBIENTE DE PRODUÇÃO
# ========================================
# Este arquivo configura todos os serviços otimizados para produção

services:
  # ----------------------------------------
  # PostgreSQL - Banco de Dados
  # ----------------------------------------
  postgres:
    image: postgres:16
    container_name: ifala-db-prd
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_INITDB_ARGS: '--data-checksums'
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
      TZ: America/Sao_Paulo
    command:
      - 'postgres'
      - '-c'
      - 'shared_preload_libraries=pg_stat_statements'
      - '-c'
      - 'max_connections=200'
      - '-c'
      - 'shared_buffers=256MB'
      - '-c'
      - 'effective_cache_size=1GB'
      - '-c'
      - 'work_mem=8MB'
      - '-c'
      - 'maintenance_work_mem=128MB'
    volumes:
      - pgdata_prd:/var/lib/postgresql/data
      - ./scripts/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - ifala-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ----------------------------------------
  # Backend - Spring Boot API
  # ----------------------------------------
  ifala-backend:
    build:
      context: ./apps/ifala-backend
      dockerfile: Dockerfile.prd
    container_name: ifala-backend-prd
    restart: always
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      SPRING_PROFILES_ACTIVE: prod
      JWT_SECRET: ${JWT_SECRET}
      #RECAPTCHA_SECRET_KEY: ${RECAPTCHA_SECRET_KEY}
      TZ: America/Sao_Paulo
    networks:
      - ifala-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--quiet',
          '--tries=1',
          '--spider',
          'http://localhost:8080/actuator/health',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ----------------------------------------
  # Frontend - React + NGINX
  # ----------------------------------------
  ifala-frontend:
    build:
      context: ./apps/ifala-frontend
      dockerfile: Dockerfile.prd
      args:
        - VITE_RECAPTCHA_SITE_KEY=${VITE_RECAPTCHA_SITE_KEY}
    container_name: ifala-frontend-prd
    restart: always
    networks:
      - ifala-network
    depends_on:
      - ifala-backend
    # healthcheck:
    #   test:
    #     [
    #       'CMD',
    #       'wget',
    #       '--quiet',
    #       '--tries=1',
    #       '--spider',
    #       'http://localhost:80',
    #     ]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

  # ----------------------------------------
  # Prometheus - Métricas
  # ----------------------------------------
  prometheus:
    image: prom/prometheus:v2.51.2
    container_name: prometheus-prd
    restart: always
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data_prd:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - ifala-network
    depends_on:
      - ifala-backend

  # ----------------------------------------
  # Grafana - Visualização e Dashboards
  # ----------------------------------------
  grafana:
    image: grafana/grafana-oss:10.4.2
    container_name: grafana-prd
    restart: always
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_INSTALL_PLUGINS: ''
      GF_SERVER_ROOT_URL: https://ifala.cacor.ifpi.edu.br/grafana/
      GF_SERVER_SERVE_FROM_SUB_PATH: true
      GF_ANALYTICS_REPORTING_ENABLED: false
      GF_ANALYTICS_CHECK_FOR_UPDATES: false
    volumes:
      - ./monitoring/grafana/provisioning/:/etc/grafana/provisioning/:ro
      - ./monitoring/grafana/dashboards/:/var/lib/grafana/dashboards/:ro
      - grafana_data_prd:/var/lib/grafana
    networks:
      - ifala-network
    depends_on:
      - prometheus
      - loki

  # ----------------------------------------
  # Loki - Agregação de Logs
  # ----------------------------------------
  loki:
    image: grafana/loki:2.9.5
    container_name: loki-prd
    restart: always
    volumes:
      - ./monitoring/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki_data_prd:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - ifala-network

  # ----------------------------------------
  # Promtail - Coletor de Logs
  # ----------------------------------------
  promtail:
    image: grafana/promtail:2.9.5
    container_name: promtail-prd
    restart: always
    volumes:
      - ./monitoring/promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - promtail_positions_prd:/var/lib/promtail
    command: -config.file=/etc/promtail/config.yml
    networks:
      - ifala-network
    depends_on:
      - loki

  # ----------------------------------------
  # NGINX Gateway - Ponto único de entrada
  # ----------------------------------------
  nginx-gateway:
    image: nginx:1.27-alpine
    container_name: nginx-gateway-prd
    restart: always
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../certs/ifala.cacor.ifpi.edu.br.crt:/etc/nginx/ssl/ifala.cacor.ifpi.edu.br.crt:ro
      - ../certs/ifala.cacor.ifpi.edu.br.key:/etc/nginx/ssl/ifala.cacor.ifpi.edu.br.key:ro
    networks:
      - ifala-network
    depends_on:
      - ifala-frontend
      - ifala-backend
      - grafana
    # healthcheck:
    #   test:
    #     [
    #       'CMD',
    #       'wget',
    #       '--quiet',
    #       '--tries=1',
    #       '--spider',
    #       '--no-check-certificate',
    #       'https://localhost:443',
    #     ]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

# ----------------------------------------
# Networks
# ----------------------------------------
networks:
  ifala-network:
    driver: bridge

# ----------------------------------------
# Volumes Persistentes
# ----------------------------------------
volumes:
  pgdata_prd:
    external: true # Volume criado manualmente - protegido contra 'docker compose down -v'
  provas_data_prd:
    external: true
  grafana_data_prd:
    driver: local
  loki_data_prd:
    driver: local
  promtail_positions_prd:
    driver: local
  prometheus_data_prd:
    driver: local
